#!/usr/bin/env node
/**
 * Pre-build patch script for Next.js Cloudflare Workers compatibility
 * 
 * This script patches Next.js source files to fix setImmediate compatibility
 * issues with Cloudflare Workers.
 * 
 * Generated by opennextjs-cli
 * Next.js Version: 15.5.10
 */

import { existsSync, readFileSync, writeFileSync } from 'fs';
import { join } from 'path';

const nodeModulesPath = join(
  process.cwd(),
  'node_modules/next/dist/server/node-environment-extensions/fast-set-immediate.external.js'
);

if (existsSync(nodeModulesPath)) {
  try {
    let content = readFileSync(nodeModulesPath, 'utf-8');
    let patched = false;

    // Remove nodeTimers.setImmediate assignments (read-only in Cloudflare Workers)
    if (content.includes('nodeTimers.setImmediate =') && !content.includes('// PATCHED:')) {
      content = content.replace(
        /globalThis\.setImmediate\s*=\s*nodeTimers\.setImmediate\s*=/g,
        'globalThis.setImmediate ='
      );
      content = content.replace(
        /globalThis\.clearImmediate\s*=\s*nodeTimers\.clearImmediate\s*=/g,
        'globalThis.clearImmediate ='
      );
      patched = true;
    }

    // Comment out nodeTimersPromises assignments (read-only module)
    if (content.includes('nodeTimersPromises.setImmediate =') && !content.includes('// PATCHED:')) {
      content = content.replace(
        /(\s+)(const nodeTimersPromises = require\('node:timers\/promises'\);)/g,
        '$1// PATCHED: $2\n$1// Cloudflare Workers: nodeTimersPromises is read-only, skipping assignment'
      );
      content = content.replace(
        /(\s+)(nodeTimersPromises\.setImmediate\s*=\s*patchedSetImmediatePromise;)/g,
        '$1// PATCHED: $2 - Commented out because nodeTimersPromises is read-only in Cloudflare Workers'
      );
      patched = true;
    }

    if (patched) {
      content = '// PATCHED by opennextjs-cli\n' + content;
      writeFileSync(nodeModulesPath, content, 'utf-8');
      console.log('✓ Patched Next.js source for Cloudflare Workers compatibility');
    }
  } catch (error) {
    console.warn('⚠ Could not patch Next.js source:', error?.message || String(error));
  }
} else {
  console.log('ℹ Next.js source file not found, skipping pre-build patch');
}
